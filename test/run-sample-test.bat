@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

echo =========================================
echo   ìƒ˜í”Œ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
echo =========================================
echo.

echo [ì •ë³´] ìƒ˜í”Œ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
echo [ê²½ê³ ] ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
echo        - ìƒ˜í”Œ í…Œì´ë¸” ìƒì„± (ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œë¨)
echo        - ìƒ˜í”Œ ë°ì´í„° ìž…ë ¥
echo        - ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo.

set /p confirm="ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/N): "
if /i not "%confirm%"=="Y" (
    echo ì‚¬ìš©ìžê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.
    pause
    exit /b 0
)

echo.
echo =========================================
echo   1ë‹¨ê³„: ìƒ˜í”Œ í…Œì´ë¸” ìƒì„±
echo =========================================
echo.

echo [ì‹¤í–‰] ìƒ˜í”Œ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤...
echo [íŒŒì¼] test/create-sample-tables.sql
echo.

:: SQLCMDë¡œ í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if exist "create-sample-tables.sql" (
    echo SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì‹¤í–‰í•©ë‹ˆë‹¤...
    echo.
    
    :: SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì—°ê²° ì •ë³´ëŠ” í™˜ê²½ì— ë§žê²Œ ìˆ˜ì •)
    echo [ì°¸ê³ ] SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ê±°ë‚˜ ì ì ˆí•œ DB ì—°ê²° ì •ë³´ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
    echo [ëª…ë ¹] sqlcmd -S "ì„œë²„ëª…" -d "ë°ì´í„°ë² ì´ìŠ¤ëª…" -i "test\create-sample-tables.sql"
    echo.
    
    set /p run_sql="SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ë¯¸ ì‹¤í–‰í–ˆìŠµë‹ˆê¹Œ? (Y/N): "
    if /i not "%run_sql%"=="Y" (
        echo SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.
        echo ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜: test\create-sample-tables.sql
        pause
        exit /b 1
    )
) else (
    echo [ì˜¤ë¥˜] í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: test\create-sample-tables.sql
    pause
    exit /b 1
)

echo.
echo =========================================
echo   2ë‹¨ê³„: ìƒ˜í”Œ ë°ì´í„° ìž…ë ¥
echo =========================================
echo.

echo [ì‹¤í–‰] ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìž…ë ¥í•©ë‹ˆë‹¤...
echo [íŒŒì¼] test/insert-sample-data.sql
echo.

if exist "test\insert-sample-data.sql" (
    echo SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.
    echo.
    
    echo [ì°¸ê³ ] ë°ì´í„° ìž…ë ¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
    echo [ëª…ë ¹] sqlcmd -S "ì„œë²„ëª…" -d "ë°ì´í„°ë² ì´ìŠ¤ëª…" -i "test\insert-sample-data.sql"
    echo.
    
    set /p run_data="ë°ì´í„° ìž…ë ¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ë¯¸ ì‹¤í–‰í–ˆìŠµë‹ˆê¹Œ? (Y/N): "
    if /i not "%run_data%"=="Y" (
        echo ë°ì´í„° ìž…ë ¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.
        echo ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜: test\insert-sample-data.sql
        pause
        exit /b 1
    )
) else (
    echo [ì˜¤ë¥˜] ë°ì´í„° ìž…ë ¥ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: test\insert-sample-data.sql
    pause
    exit /b 1
)

echo.
echo =========================================
echo   3ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¤ì • ê²€ì¦
echo =========================================
echo.

echo [ì‹¤í–‰] ìƒ˜í”Œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¤ì •ì„ ê²€ì¦í•©ë‹ˆë‹¤...
echo [ì„¤ì •] test/sample-migration-test.json
echo.

if exist "test\sample-migration-test.json" (
    node ..\src\migrate-cli.js validate --query test\sample-migration-test.json
    
    if errorlevel 1 (
        echo.
        echo [ì˜¤ë¥˜] ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¤ì • ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
        echo.
        echo ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ë©´ ì°½ì´ ë‹«íž™ë‹ˆë‹¤...
        pause >nul
        exit /b 1
    )
    
    echo.
    echo âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¤ì • ê²€ì¦ ì„±ê³µ!
) else (
    echo [ì˜¤ë¥˜] ë§ˆì´ê·¸ë ˆì´ì…˜ ì¿¼ë¦¬ë¬¸ì •ì˜ íŒŒì¼ ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: test\sample-migration-test.json
    pause
    exit /b 1
)

echo.
echo =========================================
echo   4ë‹¨ê³„: DRY RUN í…ŒìŠ¤íŠ¸
echo =========================================
echo.

echo [ì‹¤í–‰] DRY RUN ëª¨ë“œë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤...
echo [ëª¨ë“œ] ì‹¤ì œ ë°ì´í„° ë³€ê²½ ì—†ì´ ê²€ì¦ë§Œ ìˆ˜í–‰
echo.

node ..\src\migrate-cli.js migrate --query test\sample-migration-test.json --dry-run

if errorlevel 1 (
    echo.
    echo [ì˜¤ë¥˜] DRY RUN í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
    echo.
    echo ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ë©´ ì°½ì´ ë‹«íž™ë‹ˆë‹¤...
    pause >nul
    exit /b 1
)

echo.
echo âœ… DRY RUN í…ŒìŠ¤íŠ¸ ì„±ê³µ!

echo.
echo =========================================
echo   5ë‹¨ê³„: ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
echo =========================================
echo.

echo [í™•ì¸] ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
echo [ê²½ê³ ] íƒ€ê²Ÿ ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ê°€ ë³€ê²½ë©ë‹ˆë‹¤!
echo.

set /p run_migration="ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/N): "
if /i not "%run_migration%"=="Y" (
    echo.
    echo [ì™„ë£Œ] DRY RUN í…ŒìŠ¤íŠ¸ê¹Œì§€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
    echo [ì°¸ê³ ] ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì›í•˜ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:
    echo        node ..\src\migrate-cli.js migrate --query test\sample-migration-test.json
    echo.
    echo ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ë©´ ì°½ì´ ë‹«íž™ë‹ˆë‹¤...
    pause >nul
    exit /b 0
)

echo.
echo [ì‹¤í–‰] ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹œìž‘í•©ë‹ˆë‹¤...
echo.

node ..\src\migrate-cli.js migrate --query test\sample-migration-test.json

if errorlevel 1 (
    echo.
    echo [ì˜¤ë¥˜] ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
    echo.
    echo ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ë©´ ì°½ì´ ë‹«íž™ë‹ˆë‹¤...
    pause >nul
    exit /b 1
)

echo.
echo =========================================
echo   í…ŒìŠ¤íŠ¸ ì™„ë£Œ
echo =========================================
echo.

echo âœ… ìƒ˜í”Œ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
echo.

echo ðŸ“Š ìˆ˜í–‰ëœ ìž‘ì—…:
echo   1. âœ… ìƒ˜í”Œ í…Œì´ë¸” ìƒì„± (8ê°œ í…Œì´ë¸”)
echo   2. âœ… ìƒ˜í”Œ ë°ì´í„° ìž…ë ¥ (ì‹¤ì œì ì¸ í…ŒìŠ¤íŠ¸ ë°ì´í„°)
echo   3. âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¤ì • ê²€ì¦
echo   4. âœ… DRY RUN ì‹œë®¬ë ˆì´ì…˜
echo   5. âœ… ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
echo.

echo ðŸŽ¯ í…ŒìŠ¤íŠ¸ëœ ê¸°ëŠ¥:
echo   - ðŸ”— ì™¸ëž˜í‚¤ ê´€ê³„ ì²˜ë¦¬
echo   - ðŸ“Š ë™ì  ë³€ìˆ˜ ì¶”ì¶œ
echo   - ðŸŽ¯ ì¡°ê±´ë¶€ ë°ì´í„° í•„í„°ë§
echo   - ðŸ›¡ï¸ isWritable ê¶Œí•œ ê²€ì¦
echo   - ðŸ“‹ ë³µìž¡í•œ JOIN ì¿¼ë¦¬
echo   - ðŸ•’ ë‚ ì§œ ê¸°ë°˜ í•„í„°ë§
echo.

echo ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ë©´ ì°½ì´ ë‹«íž™ë‹ˆë‹¤...
pause >nul 