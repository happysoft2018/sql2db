<?xml version="1.0" encoding="UTF-8"?>
<migration>
  <!-- 전역 기본 설정 -->
  <settings>
    <!-- 데이터베이스 연결 설정 (dbinfo.json 참조) -->
    <sourceDatabase>sourceDB</sourceDatabase>
    <targetDatabase>targetDB</targetDatabase>
    <!-- 이관 기본 설정 -->
    <batchSize>${batchSize}</batchSize>
    <deleteBeforeInsert>true</deleteBeforeInsert>
  </settings>

  <!-- 전역 변수 정의 -->
  <variables>
    <var name="startDate">2024-01-01</var>
    <var name="endDate">2025-12-31</var>
    <var name="batchSize">1000</var>
    <var name="companyCode">COMPANY01</var>
    <var name="statusList">["ACTIVE", "PENDING", "APPROVED"]</var>
    <var name="categoryIds">[1, 2, 3, 5, 8]</var>
    <var name="departmentCodes">["IT", "HR", "SALES", "MARKETING"]</var>
    <var name="enableForeignKeyOrder">true</var>
    <var name="migrationTimestamp">2024-12-01 15:30:00</var>
    <var name="migrationUser">SYSTEM_MIGRATOR</var>
    <!-- 현재 시각 함수 사용 예시 -->
    <var name="currentTimestamp">${CURRENT_TIMESTAMP}</var>
    <var name="currentDate">${CURRENT_DATE}</var>
    <var name="currentTime">${CURRENT_TIME}</var>
  </variables>

  <!-- 전역 컬럼 오버라이드 설정 -->
  <globalColumnOverrides>
    <!-- 모든 쿼리에 공통으로 적용될 컬럼 값들 -->
    <override column="migration_date">${migrationTimestamp}</override>
    <override column="processed_at">GETDATE()</override>
    <override column="data_version">2.1</override>
  </globalColumnOverrides>

  <!-- 전역 전처리/후처리 그룹 -->
  <globalProcesses>
    <!-- 전체 이관 시작 전 실행 그룹들 -->
    <preProcessGroups>
     
      <group id="logging" description="마이그레이션 로그 초기화" enabled="true">
        <![CDATA[
          -- 마이그레이션 시작 로그
          INSERT INTO migration_log (query_id, phase, message, created_date)
          VALUES ('migrate_users', 'PRE_PROCESS', 'Migration started', GETDATE());
          
        ]]>
      </group>
      
      <group id="validation" description="데이터 검증" enabled="false">
        <![CDATA[
          -- 소스 데이터 기본 검증
          IF EXISTS (SELECT 1 FROM users WHERE username IS NULL OR email IS NULL)
          BEGIN
            INSERT INTO validation_errors (error_type, error_message, created_date)
            VALUES ('NULL_REQUIRED_FIELDS', 'Required fields contain NULL values', GETDATE());
          END;
          
          -- 중복 데이터 체크
          IF EXISTS (SELECT user_id, COUNT(*) FROM users GROUP BY user_id HAVING COUNT(*) > 1)
          BEGIN
            RAISERROR('중복된 사용자 ID가 발견되었습니다. 마이그레이션을 중단합니다.', 16, 1);
          END;
        ]]>
      </group>
    </preProcessGroups>
    
    <!-- 전체 이관 완료 후 실행 그룹들 -->
    <postProcessGroups>
      <group id="performance_restore" description="성능 최적화 복원" enabled="false">
        <![CDATA[
          -- 인덱스 재구성
          ALTER INDEX ALL ON users REBUILD;
          ALTER INDEX ALL ON products REBUILD;
          
          -- 제약조건 활성화
          ALTER TABLE users WITH CHECK CHECK CONSTRAINT ALL;
          ALTER TABLE products WITH CHECK CHECK CONSTRAINT ALL;
          
          -- 통계 정보 업데이트 활성화 및 실행
          ALTER DATABASE ${targetDatabase} SET AUTO_UPDATE_STATISTICS ON;
          UPDATE STATISTICS users WITH FULLSCAN;
          UPDATE STATISTICS products WITH FULLSCAN;
        ]]>
      </group>
      
      <group id="verification" description="데이터 검증" enabled="false">
        <![CDATA[
          -- 이관 후 데이터 개수 검증
          DECLARE @source_count INT, @target_count INT;
          SELECT @source_count = 0;
          SELECT @target_count = COUNT(*) FROM users WHERE created_date = '${migrationTimestamp}';
          
          IF @source_count != @target_count
          BEGIN
            INSERT INTO validation_errors (error_type, error_message, expected_value, actual_value, created_date)
            VALUES ('COUNT_MISMATCH', 'Source and target counts do not match', @source_count, @target_count, GETDATE());
          END
        ]]>
      </group>
      
      <group id="completion" description="완료 로그" enabled="true">
        <![CDATA[
          -- 이관 완료 로그 기록
          INSERT INTO migration_log (query_id, status, message, rows_processed, created_date) 
          VALUES ('migrate_users', 'COMPLETED', 'Data migration completed successfully', 
                  (SELECT COUNT(*) FROM users WHERE created_date = '${migrationTimestamp}'), GETDATE());
          
        ]]>
      </group>
    </postProcessGroups>
  </globalProcesses>

  <!-- 동적 변수 정의 -->
  <dynamicVariables>
    <dynamicVar id="extract_active_user_ids" 
                description="활성 사용자 ID 목록 추출"
                variableName="activeUserIds"
                extractType="single_column"
                columnName="user_id"
                enabled="true">
      <![CDATA[
        SELECT user_id FROM users 
        WHERE status = 'ACTIVE' 
          AND last_login_date >= '${startDate}'
          AND user_id IS NOT NULL
        ORDER BY user_id
      ]]>
    </dynamicVar>

    <!-- key_value_pairs 사용 예시들 -->
    <dynamicVar id="extract_company_mapping"
                description="회사 코드-이름 매핑 추출" 
                variableName="companyMapping"
                extractType="key_value_pairs"
                enabled="true">
      <![CDATA[
        SELECT company_code, company_name FROM companies WHERE status = 'ACTIVE'
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_department_mapping"
                description="부서 코드-이름 매핑 추출"
                variableName="departmentMapping"
                extractType="key_value_pairs"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT department_code, department_name 
        FROM departments 
        WHERE is_active = 1
 
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_status_mapping"
                description="상태 코드-설명 매핑 추출"
                variableName="statusMapping"
                extractType="key_value_pairs"
                enabled="true">
      <![CDATA[
        SELECT status_code, status_description 
        FROM status_codes 
        WHERE category = 'USER_STATUS'

      ]]>
    </dynamicVar>

    <dynamicVar id="extract_category_mapping"
                description="카테고리 ID-이름 매핑 추출"
                variableName="categoryMapping"
                extractType="key_value_pairs"
                enabled="false">
      <![CDATA[
        SELECT category_id, category_name 
        FROM categories 
        WHERE is_active = 1 
          AND category_id IN (${categoryIds})
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_max_order_id"
                description="최대 주문 ID 추출"
                variableName="maxOrderId"
                extractType="single_value"
                enabled="false">
      <![CDATA[
        SELECT MAX(order_id) as max_id FROM orders
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_category_products"
                description="특정 카테고리의 모든 상품 ID 추출"
                variableName="categoryProductIds"
                extractType="column_identified"
                columns="product_id,category_id"
                enabled="true">
      <![CDATA[
        SELECT product_id, category_id FROM products WHERE category_id IN (${categoryIds})
      ]]>
    </dynamicVar>

    <!-- 추가 multiple_columns 사용 예시들 -->
    <dynamicVar id="extract_all_entity_ids"
                description="여러 테이블의 ID 값들을 하나의 배열로 통합 추출"
                variableName="allEntityIds"
                extractType="multiple_columns"
                columns="user_id,department_id,manager_id"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT
          u.user_id,
          u.department_id,
          d.manager_id
        FROM users u
        LEFT JOIN departments d ON u.department_id = d.department_id
        WHERE u.status IN (${statusList})
          AND u.created_date >= '${startDate}'
          AND u.user_id IS NOT NULL
          AND u.department_id IS NOT NULL
          AND d.manager_id IS NOT NULL
      ]]>
    </dynamicVar>

    <!-- 방법 1: 개별 컬럼별 동적 변수 (각 컬럼을 개별적으로 식별 가능) -->
    <dynamicVar id="extract_approver_codes"
                description="승인자 코드만 추출"
                variableName="approverCodes"
                extractType="single_column"
                columnName="approver_code"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT ar.approver_code
        FROM approval_requests ar
        WHERE ar.status IN (${statusList})
          AND ar.requested_date >= '${startDate}'
          AND ar.approver_code IS NOT NULL
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_requester_codes"
                description="요청자 코드만 추출"
                variableName="requesterCodes"
                extractType="single_column"
                columnName="requester_code"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT ar.requester_code
        FROM approval_requests ar
        WHERE ar.status IN (${statusList})
          AND ar.requested_date >= '${startDate}'
          AND ar.requester_code IS NOT NULL
      ]]>
    </dynamicVar>

    <dynamicVar id="extract_product_codes"
                description="제품 코드만 추출"
                variableName="productCodes"
                extractType="single_column"
                columnName="product_code"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT ar.product_code
        FROM approval_requests ar
        WHERE ar.status IN (${statusList})
          AND ar.requested_date >= '${startDate}'
          AND ar.product_code IS NOT NULL
      ]]>
    </dynamicVar>

    <!-- 방법 2: 통합 추출 (기존 방식 유지) -->
    <dynamicVar id="extract_approval_codes"
                description="승인 관련 모든 코드들을 통합 추출 (컬럼 구분 불가)"
                variableName="allApprovalCodes"
                extractType="multiple_columns"
                columns="approver_code,requester_code,product_code"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT 
          ar.approver_code,
          ar.requester_code,
          ar.product_code
        FROM approval_requests ar
        WHERE ar.status IN (${statusList})
          AND ar.requested_date >= '${startDate}'
          AND ar.approver_code IS NOT NULL
          AND ar.requester_code IS NOT NULL
          AND ar.product_code IS NOT NULL
      ]]>
    </dynamicVar>

    <!-- 방법 3: 컬럼별 식별 가능한 구조로 추출 (NEW!) -->
    <dynamicVar id="extract_approval_codes_identified"
                description="승인 관련 코드들을 컬럼별로 식별 가능하게 추출"
                variableName="approvalCodesById"
                extractType="column_identified"
                columns="approver_code,requester_code,product_code"
                enabled="true">
      <![CDATA[
        SELECT DISTINCT 
          ar.approver_code,
          ar.requester_code,
          ar.product_code
        FROM approval_requests ar
        WHERE ar.status IN (${statusList})
          AND ar.requested_date >= '${startDate}'
          AND ar.approver_code IS NOT NULL
          AND ar.requester_code IS NOT NULL
          AND ar.product_code IS NOT NULL
      ]]>
    </dynamicVar>
  </dynamicVariables>

  <!-- 쿼리 정의 -->
  <queries>
    <!-- 사용자 테이블 데이터 이관 -->
    <query id="migrate_users"
           description="사용자 테이블 데이터 이관"
           targetTable="users"
           targetColumns="*"
           primaryKey="username"
           enabled="true">
      <!-- 이 쿼리 실행 전 전처리 -->
      <preProcess description="사용자 테이블 이관 준비">
        <![CDATA[
          -- 임시 테이블 생성
          IF OBJECT_ID('tempdb..#temp_users') IS NOT NULL DROP TABLE #temp_users;
          CREATE TABLE #temp_users (user_id INT, old_status VARCHAR(50), new_status VARCHAR(50));
          
          -- 회사별 통계 로그 (key_value_pairs 동적변수 사용)
          INSERT INTO migration_stats (query_id, table_name, stat_type, stat_category, stat_name, stat_value)
          SELECT 'migrate_users', 'users', 'OVERALL', 'DATA', 'user_count', COUNT(*) 
          FROM users 
          WHERE company_code IN (${companyMapping})
            AND created_date >= '${startDate}'
          GROUP BY company_code;
          
          -- 로그 기록
          INSERT INTO migration_log (query_id, phase, message, created_date)
          VALUES ('migrate_users', 'PRE_PROCESS', 'User migration preparation completed', GETDATE());
        ]]>
      </preProcess>
      
      <sourceQuery>
        <![CDATA[
          SELECT *
          FROM users 
          WHERE created_date >= '${startDate}' 
            AND created_date <= '${endDate}' 
          
        ]]>
      </sourceQuery>
      
      <!-- 이 쿼리 실행 후 후처리 -->
      <postProcess description="사용자 테이블 이관 마무리">
        <![CDATA[
          -- 데이터 검증 (동적변수 사용)
          DECLARE @source_count INT, @target_count INT, @active_user_count INT;
          SELECT @target_count = COUNT(*) FROM users WHERE created_date = '${migrationTimestamp}';
          SELECT @active_user_count = COUNT(*) FROM users WHERE user_id IN (${activeUserIds});
          
          -- 통계 업데이트
          UPDATE STATISTICS users;
          
          -- 완료 로그 기록
          INSERT INTO migration_log (query_id, phase, message, rows_processed, active_users, created_date)
          VALUES ('migrate_users', 'POST_PROCESS', 'User migration completed successfully', 
                  @target_count, @active_user_count, GETDATE());
          
          -- 임시 테이블 정리
          IF OBJECT_ID('tempdb..#temp_users') IS NOT NULL DROP TABLE #temp_users;
        ]]>
      </postProcess>
    </query>

    <!-- 상품 테이블 전체 데이터 이관 (SELECT * 사용) -->
    <query id="migrate_products_all"
           description="상품 테이블 전체 데이터 이관 (SELECT * 사용)"
           targetTable="products"
           targetColumns="*"
           primaryKey="product_code"
           enabled="true">
      <sourceQuery applyGlobalColumns="all">
        <![CDATA[
          SELECT *
          FROM products 
          WHERE status = 'ACTIVE'
        ]]>
      </sourceQuery>
    </query>

    <!-- 주문 테이블 데이터 이관 (SQL 파일 사용) -->
    <query id="migrate_orders_from_file"
           description="주문 테이블 데이터 이관 (SQL 파일 사용)"
           sourceQueryFile="sql/orders_migration.sql"
           targetTable="orders"
           targetColumns="*"
           primaryKey="order_number"
           enabled="true">
    </query>

    <!-- 특정 상태의 상품 데이터 이관 (IN절 사용) -->
    <query id="migrate_products_by_status"
           description="특정 상태의 상품 데이터 이관 (IN절 사용)"
           targetTable="products"
           targetColumns="*"
           primaryKey="product_code"
           enabled="true">
      <sourceQuery applyGlobalColumns="data_version">
        <![CDATA[
          SELECT *
          FROM products 
          WHERE status IN (${statusList}) 
            AND category_id IN (${categoryIds}) 
    
        ]]>
      </sourceQuery>

    </query>

    <!-- 특정 부서 직원 데이터 이관 (IN절 사용) -->
    <query id="migrate_employees_by_department"
           description="특정 부서 직원 데이터 이관 (IN절 사용)"
           targetTable="employees"
           targetColumns="*"
           primaryKey="emp_code"
           enabled="true">
      <sourceQuery applyGlobalColumns="all">
        <![CDATA[
          SELECT *
          FROM employees 
          WHERE department_code IN (${departmentCodes}) 
            AND hire_date >= '${startDate}' 
        
        ]]>
      </sourceQuery>

    </query>

    <!-- 상품 테이블 데이터 이관 (SQL 파일 + IN절 변수 사용) -->
    <query id="migrate_products_from_file_with_in"
           description="상품 테이블 데이터 이관 (SQL 파일 + IN절 변수 사용)"
           sourceQueryFile="sql/products_in_clause_example.sql"
           targetTable="products"
           targetColumns="*"
           primaryKey="product_code"
           enabled="true">
    </query>

    <!-- 활성 사용자의 주문 데이터 이관 (동적 변수 사용) -->
    <query id="migrate_user_orders_dynamic"
           description="활성 사용자의 주문 데이터 이관 (동적 변수 사용)"
           targetTable="orders"
           targetColumns="*"
           primaryKey="order_number"
           enabled="true">
      <sourceQuery>
        <![CDATA[
          SELECT *
          FROM orders 
          WHERE customer_id IN (${activeUserIds}) 
            AND order_date >= '${startDate}' 
  
        ]]>
      </sourceQuery>

    </query>

    <!-- 추출된 상품 관련 데이터 이관 (동적 변수 사용) -->
    <query id="migrate_related_products_dynamic"
           description="추출된 상품 관련 데이터 이관 (동적 변수 사용)"
           targetTable="product_reviews"
           targetColumns="*"
           primaryKey="product_id,customer_id"
           enabled="true">
      <sourceQuery>
        <![CDATA[
          SELECT * 
          FROM product_reviews 
          WHERE product_id IN (${categoryProductIds.product_id}) 
            AND rating >= 4
        ]]>
      </sourceQuery>

    </query>

    <!-- multiple_columns 동적 변수 사용 예시 쿼리들 -->
    <query id="migrate_related_entities"
           description="multiple_columns로 추출된 모든 엔티티 ID를 사용한 관련 데이터 이관"
           targetTable="entity_relationships"
           targetColumns="relation_id,entity_id,related_entity_id,relation_type,created_date"
           primaryKey="relation_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            relation_id,
            entity_id,
            related_entity_id,
            relation_type,
            created_date
          FROM entity_relationships 
          WHERE entity_id IN (${allEntityIds})
             OR related_entity_id IN (${allEntityIds})
          
        ]]>
      </sourceQuery>

    </query>

    <!-- 방법 1: 개별 변수를 사용한 쿼리 -->
    <query id="migrate_approver_audit_logs"
           description="승인자 코드만을 사용한 감사 로그 이관"
           targetTable="audit_logs"
           targetColumns="log_id,action_type,entity_code,user_code,log_message,created_date"
           primaryKey="log_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            log_id,
            action_type,
            entity_code,
            user_code,
            log_message,
            created_date
          FROM audit_logs 
          WHERE user_code IN (${approverCodes})
            AND created_date >= '${startDate}'
            AND action_type IN ('APPROVE', 'REJECT')
     
        ]]>
      </sourceQuery>

    </query>

    <query id="migrate_requester_audit_logs"
           description="요청자 코드만을 사용한 감사 로그 이관"
           targetTable="audit_logs"
           targetColumns="log_id,action_type,entity_code,user_code,log_message,created_date"
           primaryKey="log_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            log_id,
            action_type,
            entity_code,
            user_code,
            log_message,
            created_date
          FROM audit_logs 
          WHERE user_code IN (${requesterCodes})
            AND created_date >= '${startDate}'
            AND action_type = 'REQUEST'
      
        ]]>
      </sourceQuery>

    </query>

    <!-- 방법 2: multiple_columns 사용 (기존) -->
    <query id="migrate_audit_logs_by_codes"
           description="multiple_columns로 추출된 승인 코드들로 감사 로그 이관"
           targetTable="audit_logs"
           targetColumns="log_id,action_type,entity_code,user_code,log_message,created_date"
           primaryKey="log_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            log_id,
            action_type,
            entity_code,
            user_code,
            log_message,
            created_date
          FROM audit_logs 
          WHERE (entity_code IN (${allApprovalCodes}) 
             OR user_code IN (${allApprovalCodes}))
            AND created_date >= '${startDate}'
            AND action_type IN ('APPROVE', 'REJECT', 'REQUEST')
  
        ]]>
      </sourceQuery>

    </query>

    <!-- 방법 3: column_identified 사용 (NEW!) -->
    <query id="migrate_audit_logs_by_identified_codes"
           description="컬럼별로 식별된 승인 코드들을 사용한 감사 로그 이관"
           targetTable="audit_logs"
           targetColumns="log_id,action_type,entity_code,user_code,log_message,created_date"
           primaryKey="log_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            log_id,
            action_type,
            entity_code,
            user_code,
            log_message,
            created_date
          FROM audit_logs 
          WHERE (
            -- 승인자 코드로 필터링
            (user_code IN (${approvalCodesById.approver_code}) AND action_type IN ('APPROVE', 'REJECT'))
            OR 
            -- 요청자 코드로 필터링  
            (user_code IN (${approvalCodesById.requester_code}) AND action_type = 'REQUEST')
            OR
            -- 제품 코드로 필터링
            (entity_code IN (${approvalCodesById.product_code}) AND action_type LIKE '%PRODUCT%')
          )
            AND created_date >= '${startDate}'
    
        ]]>
      </sourceQuery>

    </query>

    <!-- 컬럼별 식별을 활용한 복합 쿼리 예시 -->
    <query id="migrate_complex_approval_relations"
           description="컬럼별 식별된 코드들을 사용한 복합 관계 데이터 이관"
           targetTable="approval_relations"
           targetColumns="relation_id,approver_id,requester_id,product_id,relation_type,created_date"
           primaryKey="relation_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            ar.relation_id,
            ar.approver_id,
            ar.requester_id,
            ar.product_id,
            ar.relation_type,
            ar.created_date
          FROM approval_relations ar
          WHERE ar.approver_id IN (${approvalCodesById.approver_code})
            AND ar.requester_id IN (${approvalCodesById.requester_code})
            AND ar.product_id IN (${approvalCodesById.product_code})
            AND ar.created_date >= '${startDate}'
          UNION
          SELECT 
            ar2.relation_id,
            ar2.approver_id,
            ar2.requester_id,
            ar2.product_id,
            ar2.relation_type,
            ar2.created_date
          FROM approval_relations ar2
          WHERE (ar2.approver_id IN (${approvalCodesById}) 
             OR ar2.requester_id IN (${approvalCodesById}))
            AND ar2.created_date >= '${startDate}'

        ]]>
      </sourceQuery>

    </query>

    <!-- key_value_pairs 사용 예시 쿼리들 -->
    <query id="migrate_users_with_company_names"
           description="회사 코드-이름 매핑을 사용한 사용자 데이터 이관"
           targetTable="users_with_company"
           targetColumns="user_id,username,email,company_code,company_name,created_date"
           primaryKey="user_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            u.user_id,
            u.username,
            u.email,
            u.company_code,
            -- key_value_pairs 매핑을 이용한 회사명 조회
            CASE u.company_code
              WHEN 'COMPANY01' THEN ${companyMapping.COMPANY01}
              WHEN 'COMPANY02' THEN ${companyMapping.COMPANY02}
              WHEN 'COMPANY03' THEN ${companyMapping.COMPANY03}
              ELSE 'Unknown Company'
            END as company_name,
            u.created_date
          FROM users u
          WHERE u.company_code IN (${companyMapping})
            AND u.created_date >= '${startDate}'

        ]]>
      </sourceQuery>

    </query>

    <query id="migrate_employees_with_dept_info"
           description="부서 매핑을 사용한 직원 정보 이관"
           targetTable="employees_with_dept"
           targetColumns="emp_id,emp_name,dept_code,dept_name,status,status_desc,hire_date"
           primaryKey="emp_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            e.emp_id,
            e.emp_name,
            e.dept_code,
            -- 부서명 매핑
            COALESCE(${departmentMapping.${e.dept_code}}, 'Unknown Department') as dept_name,
            e.status,
            -- 상태 설명 매핑  
            COALESCE(${statusMapping.${e.status}}, 'Unknown Status') as status_desc,
            e.hire_date
          FROM employees e
          WHERE e.dept_code IN (${departmentMapping})
            AND e.status IN (${statusMapping})
            AND e.hire_date >= '${startDate}'

        ]]>
      </sourceQuery>

    </query>

    <!-- key_value_pairs를 조건절에서 활용하는 예시 -->
    <query id="migrate_filtered_by_mapping"
           description="매핑 테이블 기반 필터링을 사용한 데이터 이관"
           targetTable="filtered_data"
           targetColumns="record_id,entity_code,entity_name,category_id,category_name,processed_date"
           primaryKey="record_id"
           enabled="false">
      <sourceQuery>
        <![CDATA[
          SELECT 
            rd.record_id,
            rd.entity_code,
            rd.entity_name,
            rd.category_id,
            rd.category_name,
            rd.processed_date
          FROM raw_data rd
          WHERE rd.entity_code IN (${companyMapping})  -- 매핑된 회사 코드만
            AND rd.category_id IN (${categoryMapping}) -- 매핑된 카테고리만
            AND rd.processed_date >= '${startDate}'

        ]]>
      </sourceQuery>

    </query>

    <!-- SELECT * 사용 예시 (전/후처리에서) -->
    <query id="migrate_with_select_star_in_process"
           description="전/후처리에서 SELECT * 사용 예시"
           targetTable="example_table"
           targetColumns="id,name,email,created_date"
           primaryKey="id"
           enabled="false">
      
      <!-- 전처리에서 SELECT * 사용 -->
      <preProcess description="SELECT * 를 사용한 백업 및 준비 작업">
        <![CDATA[
          -- 기존 데이터 전체 백업 (SELECT * 사용)
          INSERT INTO example_table_backup 
          SELECT * FROM example_table 
          WHERE created_date >= '${startDate}';
          
          -- 별칭을 사용한 SELECT * 예시
          INSERT INTO temp_analysis 
          SELECT t.* FROM example_table t 
          WHERE t.status = 'ACTIVE';
          
          -- 복잡한 JOIN과 함께 SELECT * 사용
          INSERT INTO detailed_backup
          SELECT u.* FROM users u
          LEFT JOIN departments d ON u.dept_id = d.id
          WHERE u.created_date >= '${startDate}' 
            AND d.is_active = 1;

          
          -- 로그 기록
          INSERT INTO migration_log (query_id, phase, message, created_date)
          VALUES ('migrate_with_select_star_in_process', 'PRE_PROCESS', 'Backup completed with SELECT *', GETDATE());
        ]]>
      </preProcess>
      
      <sourceQuery applyGlobalColumns="all">
        <![CDATA[
          SELECT id, name, email, created_date 
          FROM example_table 
          WHERE created_date >= '${startDate}' 
            AND created_date <= '${endDate}' 
  
        ]]>
      </sourceQuery>
      
      <!-- 후처리에서도 SELECT * 사용 -->
      <postProcess description="SELECT * 를 사용한 검증 및 정리 작업">
        <![CDATA[
          -- 데이터 검증을 위한 전체 컬럼 비교
          DECLARE @backup_count INT, @target_count INT;
          
          SELECT @backup_count = COUNT(*) FROM (
            SELECT * FROM example_table_backup 
            WHERE created_date >= '${startDate}'
          ) backup_data;
          
          SELECT @target_count = COUNT(*) FROM (
            SELECT * FROM example_table 
            WHERE migration_date = '${migrationTimestamp}'
          ) target_data;
          
          -- 샘플 데이터 검증 (SELECT * 로 전체 컬럼 검사)
          IF EXISTS (
            SELECT * FROM example_table 
            WHERE migration_date = '${migrationTimestamp}' 
              AND (name IS NULL OR email IS NULL)
          )
          BEGIN
            INSERT INTO migration_errors (query_id, error_message, created_date)
            VALUES ('migrate_with_select_star_in_process', 'Data validation failed: NULL values found', GETDATE());
          END
          
          -- 임시 테이블 정리
          DELETE FROM temp_analysis WHERE created_date < DATEADD(DAY, -1, GETDATE());
          
          -- 완료 로그
          INSERT INTO migration_log (query_id, phase, message, rows_processed, created_date)
          VALUES ('migrate_with_select_star_in_process', 'POST_PROCESS', 'Validation completed with SELECT *', @target_count, GETDATE());
        ]]>
      </postProcess>
      

    </query>

    <!-- 전/후처리 예시 쿼리 -->
    <query id="migrate_with_global_overrides_example"
           description="전역 columnOverrides 적용 예시"
           targetTable="audit_table"
           targetColumns="user_id,action_type,action_date,details"
           primaryKey="user_id"
                      enabled="false">

      <!-- 전처리 스크립트 -->
      <preProcess description="감사 로그 생성">
        <![CDATA[
          -- 마이그레이션 시작 로그
          INSERT INTO migration_audit_log (operation_type, start_time, table_name)
          VALUES ('DATA_MIGRATION', GETDATE(), 'users');
          
          -- 사용자 액션 로그
          INSERT INTO user_action_log (user_id, action_type, action_date, details)
          SELECT user_id, 'MIGRATION_START', GETDATE(), 'Data migration started'
          FROM users 
          WHERE created_date >= '${startDate}';
          
          -- 백업 테이블에 데이터 저장
          INSERT INTO users_backup (user_id, username, email, original_created_date)
          SELECT user_id, username, email, created_date
          FROM users 
          WHERE status = 'ACTIVE';
          
          -- 처리 통계 초기화
          UPDATE migration_stats 
          SET processed_count = 0, start_time = GETDATE()
          WHERE migration_id = '${migrationId}';
        ]]>
      </preProcess>
      
      <sourceQuery applyGlobalColumns="none">
        <![CDATA[
          SELECT user_id, 'DATA_PROCESSED' as action_type, GETDATE() as action_date, 'User data migrated' as details
          FROM users 
          WHERE created_date >= '${startDate}' 
            AND created_date <= '${endDate}' 
            AND status = 'ACTIVE'
 
        ]]>
      </sourceQuery>
      
      <!-- 후처리 스크립트 -->
      <postProcess description="마이그레이션 완료 처리">
        <![CDATA[
          -- 완료 로그 삽입
          INSERT INTO migration_audit_log (operation_type, end_time, table_name, rows_processed)
          VALUES ('DATA_MIGRATION', GETDATE(), 'audit_table', @@ROWCOUNT);
          
          -- 사용자별 완료 상태 업데이트
          UPDATE user_migration_status 
          SET status = 'COMPLETED', completion_time = GETDATE()
          WHERE user_id IN (
            SELECT user_id FROM audit_table 
            WHERE migration_date = '${migrationTimestamp}'
          );
          
          -- 통계 업데이트
          UPDATE migration_stats 
          SET processed_count = (
            SELECT COUNT(*) FROM audit_table 
            WHERE migration_date = '${migrationTimestamp}'
          ), end_time = GETDATE(), status = 'COMPLETED'
          WHERE migration_id = '${migrationId}';
          
          -- 알림 로그
          INSERT INTO notification_log (message_type, message, target_users)
          VALUES ('MIGRATION_COMPLETE', 'User data migration completed successfully', 'admin,manager');
          
          -- 임시 테이블 정리
          DELETE FROM temp_migration_data WHERE created_date < DATEADD(HOUR, -1, GETDATE());
        ]]>
      </postProcess>
    </query>

  </queries>
</migration> 